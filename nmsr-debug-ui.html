<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NMSR - Test GUI</title>
    <style>
        body {
            box-sizing: border-box;

            font-family: system-ui, sans-serif;
            margin: 0;
            padding: 1.5rem;

            display: flex;
            width: 100vw;
            height: 100vh;

            background-color: canvas;
            color: canvastext;
            color-scheme: light dark;

            overflow: hidden;

            gap: 1rem;
        }

        label,
        p {
            margin: 0;
        }

        #controls,
        #image-preview {
            flex: 1;
            display: flex;
            gap: 0.621rem;

            justify-content: center;
        }

        #controls {
            flex-direction: column;
        }

        #image-preview {
            align-items: center;
            justify-content: center;
        }

        input,
        select,
        button {
            padding: 0.5rem;
            margin-block-end: 0.5rem;
        }

        .group {
            display: flex;
            align-items: baseline;
            gap: 0.2rem;
            flex-wrap: wrap;
            flex-direction: column;
        }

        .inner-group {
            display: flex;
            flex-direction: column;
            flex: 1;

            height: 100%;
        }

        .outer-group {
            display: flex;
            flex-direction: row;
            justify-content: space-evenly;
            align-items: center;

            gap: 1rem;
        }

        h1 {
            font-size: 3.5rem;
            align-self: center;
        }
    </style>
</head>

<body>
    <div id="image-preview">
        <img src="#" alt="Image Preview" id="preview-image">
        <p id="image-error"></p>
    </div>
    <div id="controls">

        <h1>NMSR - Test GUI</h1>

        <div class="outer-group" id="texture-group">
            <div class="inner-group">
                <label for="texture-group">Texture:</label>
                <input type="text" id="texture" value="ad4569f3-7576-4376-a7c7-8e8cfcd9b832">
            </div>
            <div class="inner-group">
                <div>
                    <label for="texture-file-group">Skin Upload:</label>
                    <input type="file" id="skin-upload">
                </div>
                <div>
                    <label for="texture-file-group">Cape Upload:</label>
                    <input type="file" id="cape-upload">
                </div>
            </div>
        </div>


        <div class="outer-group">
            <div class="inner-group" id="general-controls-group">
                <label for="general-controls-group">General:</label>
                <label for="mode">Mode:</label>
                <select id="mode">
                    <option value="full_body">FullBody</option>
                    <option value="body_bust">BodyBust</option>
                    <option value="front_full">FrontFull</option>
                    <option value="front_bust">FrontBust</option>
                    <option value="face">Face</option>
                    <option value="head">Head</option>
                    <option value="full_body_iso">FullBodyIso</option>
                    <option value="head_iso">HeadIso</option>
                    <option value="skin">Skin</option>
                    <option value="cape">Cape</option>
                    <option value="custom">Custom</option>
                </select>

                <label for="model">Model:</label>
                <select id="model" name="model">
                    <option value="">(Default)</option>
                    <option value="wide">Wide</option>
                    <option value="slim">Slim</option>
                </select>

            </div>

            <div class="inner-group" id="misc-controls-group">
                <label for="misc-controls-group">Misc:</label>

                <label for="arms">Arm Rotation:</label>
                <input type="number" id="arms" name="arms" min="0" max="180" step="1">

                <label for="distance">Camera Distance:</label>
                <input type="number" id="distance" name="distance" step="1">
            </div>

            <div class="inner-group" id="features-group">
                <label for="features-group">Features:</label>
                <label><input type="checkbox" checked value="layers">Layers</label>
                <label><input type="checkbox" checked value="helmet">Helmet</label>
                <label><input type="checkbox" checked value="shadow">Shadow</label>
                <label><input type="checkbox" checked value="shading">Shading</label>
                <label><input type="checkbox" checked value="cape">Cape</label>
                <label><input type="checkbox" value="ears">Ears</label>
            </div>

        </div>

        <div class="outer-group" id="camera-group">
            <div class="inner-group" id="camera-size-group">
                <label for="camera-size-group">Size:</label>

                <label for="width">Width:</label>
                <input type="number" id="width" name="w">

                <label for="height">Height:</label>
                <input type="number" id="height" name="h">
            </div>

            <div class="inner-group" id="camera-rotation-group">
                <label for="camera-rotation-group">Rotation:</label>

                <label for="yaw">Yaw:</label>
                <input type="number" id="yaw" name="y" step="1">

                <label for="pitch">Pitch:</label>
                <input type="number" id="pitch" name="p" step="1">

                <label for="roll">Roll:</label>
                <input type="number" id="roll" name="r" step="1">
            </div>

            <div class="inner-group" id="camera-position-group">
                <label for="camera-position-group">Position:</label>

                <label for="xpos">X Position:</label>
                <input type="number" id="xpos" name="xpos" step="1" min="-50" max="50">

                <label for="ypos">Y Position:</label>
                <input type="number" id="ypos" name="ypos" step="1" min="-50" max="50">

                <label for="zpos">Z Position:</label>
                <input type="number" id="zpos" name="zpos" step="1" min="-50" max="50">
            </div>
        </div>

        <div class="outer-group" id="armor-group">
            <label for="armor-group">Armor:</label>

            <div class="inner-group">
                <label for="helmet">Helmet:</label>
                <select name="helmet" id="helmet">
                    <option value="">(None)</option>
                    <option value="le">Leather Helmet</option>
                    <option value="ch">Chainmail Helmet</option>
                    <option value="ir">Iron Helmet</option>
                    <option value="di">Diamond Helmet</option>
                    <option value="go">Golden Helmet</option>
                    <option value="tu">Turtle Helmet</option>
                    <option value="ne">Netherite Helmet</option>
                </select>
            </div>

            <div class="inner-group">
                <label for="chestplate">Chestplate:</label>
                <select name="chestplate" id="chestplate">
                    <option value="">(None)</option>
                    <option value="le">Leather Chestplate</option>
                    <option value="ch">Chainmail Chestplate</option>
                    <option value="ir">Iron Chestplate</option>
                    <option value="di">Diamond Chestplate</option>
                    <option value="go">Golden Chestplate</option>
                    <option value="tu">Turtle Chestplate</option>
                    <option value="ne">Netherite Chestplate</option>
                </select>
            </div>

            <div class="inner-group">
                <label for="leggings">Leggings:</label>
                <select name="leggings" id="leggings">
                    <option value="">(None)</option>
                    <option value="le">Leather Leggings</option>
                    <option value="ch">Chainmail Leggings</option>
                    <option value="ir">Iron Leggings</option>
                    <option value="di">Diamond Leggings</option>
                    <option value="go">Golden Leggings</option>
                    <option value="tu">Turtle Leggings</option>
                    <option value="ne">Netherite Leggings</option>
                </select>
            </div>

            <div class="inner-group">
                <label for="boots">Boots:</label>
                <select name="boots" id="boots">
                    <option value="">(None)</option>
                    <option value="le">Leather Boots</option>
                    <option value="ch">Chainmail Boots</option>
                    <option value="ir">Iron Boots</option>
                    <option value="di">Diamond Boots</option>
                    <option value="go">Golden Boots</option>
                    <option value="tu">Turtle Boots</option>
                    <option value="ne">Netherite Boots</option>
                </select>
            </div>
        </div>

        <button id="apply-button">Apply</button>
    </div>

    <script type="module">
        let modeSelect = document.getElementById('mode');
        let textureInput = document.getElementById('texture');
        let featuresGroup = document.getElementById('features-group');
        let applyButton = document.getElementById('apply-button');
        let imagePreview = document.getElementById('preview-image');
        let imageError = document.getElementById('image-error');
        let skinUpload = document.getElementById('skin-upload');
        let capeUpload = document.getElementById('cape-upload');
        let resolvedNames = {};

        let uploadedSkin = null;
        let uploadedCape = null;

        skinUpload.addEventListener('change', () => {
            let file = skinUpload.files[0];
            if (!file) return;

            let reader = new FileReader();
            reader.onload = async () => {
                uploadedSkin = new Blob([/** @type {ArrayBuffer} */(reader.result)]);;
                textureInput.value = '';
                await updateImage();
            };
            reader.readAsArrayBuffer(file);
        });

        capeUpload.addEventListener('change', () => {
            let file = capeUpload.files[0];
            if (!file) return;

            let reader = new FileReader();
            reader.onload = async () => {
                uploadedCape = new Blob([/** @type {ArrayBuffer} */(reader.result)]);;
                textureInput.value = '';
                await updateImage();
            };
            reader.readAsArrayBuffer(file);
        });

        if (window.location.search) {
            let params = new URLSearchParams(window.location.search);
            for (let [key, value] of params) {
                let input = document.querySelector(`[name="${key}"]`) || (key == 'texture' ? textureInput : (key == 'mode' ? modeSelect : null));
                if (input) {
                    input.value = value;
                }
            }
        }

        let validMinecraftName = /^[a-zA-Z0-9_]{2,16}$/;

        applyButton.addEventListener('click', updateImage);

        updateImage();

        let debouncedUpdateImage = debounce(updateImage, 300);
        document.querySelectorAll('input:not([type="checkbox"])').forEach(input => input.addEventListener('input', debouncedUpdateImage));
        document.querySelectorAll('input[type="checkbox"]').forEach(input => input.addEventListener('input', updateImage));
        document.querySelectorAll('select').forEach(input => input.addEventListener('input', updateImage));

        window.addEventListener('paste', e => {
            skinUpload.files = e.clipboardData.files;
            skinUpload.dispatchEvent(new Event('change'));
        });
        async function updateImage() {
            recursiveSetEnabled(document.getElementById('camera-position-group'), modeSelect.value == 'custom');

            // Find all inputs
            let inputs = document.querySelectorAll('input, select');

            // Create an object to store the values
            let values = {};

            // Iterate over all inputs
            for (let input of inputs) {
                // Add the value to the object if it's not empty and not disabled
                if (input.name && input.value && !input.disabled) {
                    values[input.name] = input.value;
                }
            }

            let params = new URLSearchParams(values);

            // Add the features
            let excluded = [];
            for (let feature of featuresGroup.querySelectorAll('input')) {
                if (!feature.checked) {
                    excluded.push(feature.value);
                }
            }
            if (excluded.length > 0) params.append('no', excluded.join(','));

            const url = `https://nickac-pc.werewolf-scala.ts.net/temp/nmsr`;

            if (uploadedSkin && !textureInput.value) {
                // Use POST if a skin was uploaded

                const formData = new FormData();

                for (let name of params.keys()) {
                    formData.append(name, params.get(name));
                }

                formData.append('skin', uploadedSkin);
                if (uploadedCape) formData.append('cape', uploadedCape);

                // Request image and set it as the preview, or show an error
                try {
                    const response = await fetch(`${url}/${modeSelect.value}`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(await response.text());
                    }
                    const imageBlob = await response.blob();

                    imagePreview.style.display = 'block';
                    imageError.style.display = 'none';

                    imagePreview.src = URL.createObjectURL(imageBlob);
                } catch (error) {
                    console.error('Error loading image:', error);
                    imagePreview.style.display = 'none';
                    imageError.style.display = 'block';

                    imageError.textContent = error;
                }
            } else {
                let resolvedTexture = await tryResolveName(textureInput.value);
                let imageUrl = `${url}/${modeSelect.value}/${resolvedTexture}?${params.toString()}`;
                imagePreview.src = imageUrl;
                imagePreview.style.display = 'block';
                imageError.style.display = 'none';
            }

        }

        function recursiveSetEnabled(root, enabled) {
            for (let child of root.children) {
                if (child.children.length > 0) {
                    recursiveSetEnabled(child, enabled);
                } else {
                    // Disable this input
                    child.disabled = !enabled;
                }
            }
        }

        async function tryResolveName(name) {
            if (resolvedNames && resolvedNames[name]) return resolvedNames[name];

            if (!validMinecraftName.test(name)) return name;

            let response = await fetch(`https://corsjangapi.b-cdn.net/users/profiles/minecraft/${name}`);
            if (!response.ok) return name;

            let data = await response.json();
            resolvedNames[name] = data.id;
            return data.id;
        }

        function debounce(func, timeout = 300) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

    </script>
</body>

</html>